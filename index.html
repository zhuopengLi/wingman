<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Wingman</title>
    <base href=".">

    <!-- Wingman Platform styles -->
    <link rel="stylesheet" href="../app/css/lemonade.css" type="text/css" />
    <link rel="stylesheet" href="../app/css/treeview.css" type="text/css" />

    <!-- TreeViewPlugin -->


    <style>
        html,
        body {
            height: 100%;
            background: #f2f2f2;
        }

        body {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            line-height: 1.50;
            -webkit-font-smoothing: antialiased;
            margin: 0;
            overflow: hidden;
        }

        .column {
            float: left;
            width: 100%;
        }

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        canvas {
            width: 80%;
            flex-shrink: 1;
            float: left;
        }
    </style>

</head>

<body onload="document.initAachenEarly()">


    <script type="module">


        //------------------------------------------------------------------------------------------------------------------------------------------
        // Request for geo data and sensorValue
        //------------------------------------------------------------------------------------------------------------------------------------------


        var geoData = new XMLHttpRequest();
        var globalGeoRefresh;

        function loadGeoData(url, cfunc) {
            geoData.onreadystatechange = cfunc;
            geoData.open("GET", url, true);
            geoData.send();
        }

        function loadGeo(url) {
            var localGeoRefresh = setInterval(function () {
                loadGeoData(url, function () {
                    if (geoData.readyState == 4 && geoData.status == 200) {
                        var weather = JSON.parse(geoData.responseText);
                        if (weather.coord.lon > 0) {
                            document.getElementById("location").innerHTML =
                                "Location: " + weather.coord.lat.toFixed(2) + "N, " + weather.coord.lon.toFixed(2) + "E, " + weather.name + ", " + weather.sys.country;
                        }
                        else if ((weather.coord.lon < 0)) {
                            document.getElementById("location").innerHTML =
                                "Location: " + weather.coord.lat.toFixed(2) + "N, " + Math.abs(weather.coord.lon.toFixed(2)) + "W, " + weather.name + ", " + weather.sys.country;
                        }
                        document.getElementById("weather").innerHTML =
                            "Weather: " + weather.weather[0].main + ", " + (weather.main.temp - 273.15).toFixed(2) + "°C ";
                    }
                })
            }, 5000)

            globalGeoRefresh = localGeoRefresh;

        }

        function stopGeoRefresh() {
            clearInterval(globalGeoRefresh);
        }

        //------------------------------------------------------------------------------------------------------------------
        // set up the clock
        //------------------------------------------------------------------------------------------------------------------


        var timerInterval = setInterval(function () { timer() }, 1000);

        function timer() {
            var d = new Date();
            d.setHours(d.getHours() - 7);
            var hours = d.toLocaleTimeString();
            var day = d.toDateString();
            document.getElementById("time").innerHTML = hours + ", " + day + " (CET)";
        }


        //------------------------------------------------------------------------------------------------------------------------------------------
        //
        //create viewer
        //
        //------------------------------------------------------------------------------------------------------------------------------------------


        import { Viewer } from "../src/viewer/Viewer.js";
        import { XKTLoaderPlugin } from "../src/plugins/XKTLoaderPlugin/XKTLoaderPlugin.js";

        //import menu
        import { ContextMenu } from "../src/extras/ContextMenu/ContextMenu.js";
        import { TreeViewPlugin } from "../src/plugins/TreeViewPlugin/TreeViewPlugin.js";

        //import nav cube
        import { NavCubePlugin } from "../src/plugins/NavCubePlugin/NavCubePlugin.js";

        //import mesh 
        import { Mesh } from "../src/viewer/scene/mesh/Mesh.js";
        import { VBOGeometry } from "../src/viewer/scene/geometry/VBOGeometry.js";
        import { buildGridGeometry } from "../src/viewer/scene/geometry/builders/buildGridGeometry.js";
        import { PhongMaterial } from "../src/viewer/scene/materials/PhongMaterial.js";


        const viewer = new Viewer({
            canvasId: "myCanvas"
        });

        viewer.camera.eye = [25, 150, 75];
        viewer.camera.look = [0, 5, 0];
        viewer.camera.up = [-0.01, 0.99, 0.039];


        viewer.cameraControl.doublePickFlyTo = true;
        viewer.cameraControl.panRightClick = true;
        viewer.cameraControl.followPointer = true;

        viewer.cameraControl.touchDollyRate = 1;
        viewer.cameraControl.mouseWheelDollyRate = 60;
        viewer.cameraControl.keyboardDollyRate = 20;
        viewer.cameraControl.rotationInertia = 0;
        viewer.cameraControl.dollyInertia = 0;

        //------------------------------------------------------------------------------------------------------------------
        // declare the info query list
        //------------------------------------------------------------------------------------------------------------------


        const buildingPro = [
            "Address: ",
            "Name: ",
            "Type: ",
            "Date of built: ",
            "Historic building: ",
            "Base area: ",
            "Owner of the premises: "
        ];

        const buildingProJSON = [
            "address",
            "name",
            "type",
            "date",
            "historic",
            "area",
            "owner"
        ]

        const sitePro = [
            "Address: ",
            "Name: ",
            "Type: ",
            "Date of built: ",
            "Historic building: ",
            "Base area: ",
            "Owner of the premises: ",
            "Electric consumption: ",
            "Water consumption: ",
            "Gas consumption: ",
            "Last update at: "
        ];

        const siteProJSON = [
            "address",
            "name",
            "type",
            "date",
            "historic",
            "area",
            "owner",
            "ElectricityConsumption",
            "WaterConsumption",
            "GasConsumption",
            "timestamp"
        ]

        const siteProUnit = [
            "kW/h",
            "m³/h",
            "m³/h",
            " (CET)"
        ]

        const pipePro = [
            "Type: ",
            "Depth: ",
            "Diameter: ",
            "Owner: "
        ];

        const pipeProJSON = [
            "type",
            "depth",
            "diameter",
            "owner"
        ]

        const treePro = [
            "Name: ",
            "Type: ",
            "Diameter at breast height: ",
            "Height: ",
            "Age: "
        ];

        const treeProJSON = [
            "name",
            "type",
            "diameter",
            "height",
            "age"
        ]

        const roadPro = [
            "Name: ",
            "Type: ",
            "Width: "
        ];

        const roadProJSON = [
            "name",
            "type",
            "width"
        ]

        const sensorPro = [
            "Temperature: ",
            "Moisture: ",
            "Windspeed: ",
            "Wind-direction: ",
            "Ozone: ",
            "Noise level: ",
            "Last update at: "
        ];

        const sensorProJSON = [
            "temperatures",
            "moisture",
            "windspeed",
            "winddirection",
            "ozone",
            "NoiseLevel",
            "timestamp"
        ]

        const sensorProUnit = [
            "°C",
            "%",
            "m/s",
            "°",
            "µg/m³",
            "dB",
            " (CET)"
        ]

        //------------------------------------------------------------------------------------------------------------------
        // declare sensor data query function
        //------------------------------------------------------------------------------------------------------------------


        var sensor = new XMLHttpRequest();
        var globalRefresh;

        function loadSensorData(url, cfunc) {
            sensor.onreadystatechange = cfunc;
            sensor.open("GET", url, true);
            sensor.send();
        }


        //------------------------------------------------------------------------------------------------------------------
        // declare the property query functions
        //------------------------------------------------------------------------------------------------------------------


        function clearProperty() {
            document.getElementById("info").style.margin = "1em";
            document.getElementById("info").style.fontSize = "14pt";
            document.getElementById("info").style.color = "#03103f63";
            document.getElementById("info").innerHTML = '<i>Click on objects for more info</i>';
        }

        function noProperty() {
            document.getElementById("info").style.margin = "1em";
            document.getElementById("info").style.fontSize = "14pt";
            document.getElementById("info").style.color = "#03103f63";
            document.getElementById("info").innerHTML = '<i>No infomation available</i>';
        }

        function stopRefresh(param) {
            clearInterval(param);
        }

        function getSensorPro(param, name) {
            document.getElementById("info").style.margin = "1em 1.2em 0";
            document.getElementById("info").innerHTML = "Loading sensor data...";

            var localRefresh = setInterval(function () {
                loadSensorData("https://webhooks.mongodb-realm.com/api/client/v2.0/app/sensordata-rzgof/service/sensorValue/incoming_webhook/sensorValue", function () {
                    if (sensor.readyState == 4 && sensor.status == 200) {
                        document.getElementById("info").style.margin = "0";

                        var data = JSON.parse(sensor.responseText);

                        var info = "<ul>" + "<li>" + "<b>Name: </b>" + name + "</li>";
                        for (let i = 0; i < sensorPro.length - 1; i++) {
                            info += "<li>" + "<b>" + sensorPro[i] + "</b>" + data[param][sensorProJSON[i]].$numberDouble + sensorProUnit[i] + "</li>";
                        }
                        info += "<li>" + "<b>Last update at: </b>" + data[param][sensorProJSON[6]] + sensorProUnit[6] + "</li>" + "</ul>";
                        document.getElementById("info").innerHTML = info

                    }
                })
            }, 5000);

            globalRefresh = localRefresh;
        }

        function getSmartBuildingPro(param, digit) {
            document.getElementById("info").style.margin = "1em 1.2em 0";
            document.getElementById("info").innerHTML = "Loading sensor data...";

            var localRefresh = setInterval(function () {


                loadSensorData("https://webhooks.mongodb-realm.com/api/client/v2.0/app/sensordata-rzgof/service/sensorValue/incoming_webhook/sensorValue", function () {

                    if (sensor.readyState == 4 && sensor.status == 200) {
                        document.getElementById("info").style.margin = "0";



                        var data = JSON.parse(sensor.responseText);
                        var info = "<ul>"
                        for (let i = 0; i < sitePro.length - 4; i++) {
                            info += "<li>" + "<b>" + sitePro[i] + "</b>" + param[siteProJSON[i]] + "</li>";
                        }
                        info += "<hr/>"
                        for (let i = 7; i < sitePro.length - 1; i++) {
                            info += "<li>" + "<b>" + sitePro[i] + "</b>" + data[digit][siteProJSON[i]].$numberDouble + siteProUnit[i - 7] + "</li>";
                        }

                        info += "<li>" + "<b>Last update at: </b>" + data[digit][siteProJSON[10]] + siteProUnit[3] + "</li>" + "</ul>";

                        document.getElementById("info").innerHTML = info
                    }
                })
            }, 5000);

            globalRefresh = localRefresh;
        }

        function getBuildingPro(param) { //edit metascene.js, metaobject.js and metamodel.js
            document.getElementById("info").style.margin = "0";

            var info = "<ul>"
            for (let i = 0; i < buildingPro.length; i++) {
                info += "<li>" + "<b>" + buildingPro[i] + "</b>" + param[buildingProJSON[i]] + "</li>";
            }
            info += "</ul>";
            document.getElementById("info").innerHTML = info
        }

        function getPipePro(param) { //edit metascene.js, metaobject.js and metamodel.js
            document.getElementById("info").style.margin = "0";

            var info = "<ul>"
            for (let i = 0; i < pipePro.length; i++) {
                info += "<li>" + "<b>" + pipePro[i] + "</b>" + param[pipeProJSON[i]] + "</li>";
            }
            info += "</ul>";
            document.getElementById("info").innerHTML = info
        }

        function getStreetsPro(param) { //edit metascene.js, metaobject.js and metamodel.js
            document.getElementById("info").style.margin = "0";

            var info = "<ul>"
            for (let i = 0; i < roadPro.length; i++) {
                info += "<li>" + "<b>" + roadPro[i] + "</b>" + param[roadProJSON[i]] + "</li>";
            }
            info += "</ul>";
            document.getElementById("info").innerHTML = info
        }

        function getTreePro(param) { //edit metascene.js, metaobject.js and metamodel.js
            document.getElementById("info").style.margin = "0";

            var info = "<ul>"
            for (let i = 0; i < treePro.length; i++) {
                info += "<li>" + "<b>" + treePro[i] + "</b>" + param[treeProJSON[i]] + "</li>";
            }
            info += "</ul>";
            document.getElementById("info").innerHTML = info
        }

        function getInfo(param) {
            const id = param.id;
            const name = param.name;

            if (param.parent != undefined) {
                const parent = param.parent.id;

                if (id == "0RcD6OWIT3aeDtzYT9gg1Q") { getSensorPro(2, name) } //sensors
                else if (id == "0RcD6OWIT3aeDtzYT9ggz_") { getSensorPro(3, name) }
                else if (id == "0RcD6OWIT3aeDtzYT9gg1y") { getSensorPro(4, name) }
                else if (id == "0RcD6OWIT3aeDtzYT9gg1F") { getSensorPro(5, name) }
                else if (id == "0RcD6OWIT3aeDtzYT9gg1K") { getSensorPro(6, name) }
                else if (id == "1pEomJbuL6pAjDLauPLdDj") { getSmartBuildingPro(param, 1) } //completed building
                else if (param.parent.parent.id == "Buildings") { getBuildingPro(param) }
                else if (param.parent.parent.id == "Pipe networks") { getPipePro(param) }
                else if (parent == "Streets") { getStreetsPro(param) }
                else if (parent == "Planting") { getTreePro(param) }
                else { noProperty() }
            }
            else { noProperty() }
        }


        //------------------------------------------------------------------------------------------------------------------
        // Load models
        //------------------------------------------------------------------------------------------------------------------


        const xktLoader = new XKTLoaderPlugin(viewer);

        var globalModel = [];

        var globalCraneRefresh;

        var globalCrane;

        function clearCanvas() {
            globalModel.forEach(element => element.destroy());
            globalModel.length = 0;
            stopRefresh(globalRefresh);
            stopGeoRefresh();
            lastEntity = null;
            clearProperty();
            document.getElementById("location").innerHTML = "Loading geo data...";
            document.getElementById("weather").innerHTML = "";
        }

        function enable(i, value) {
            document.getElementsByTagName("button")[i].setAttribute("onclick", value)
            document.getElementsByTagName("button")[i].removeAttribute("disabled")
            document.getElementsByTagName("button")[i].style.backgroundColor = "white";
            document.getElementsByTagName("button")[i].style.fontStyle = "normal";
        }

        function disable(i) {
            document.getElementsByTagName("button")[i].setAttribute("disabled", "disabled")
            document.getElementsByTagName("button")[i].removeAttribute("onclick")
            document.getElementsByTagName("button")[i].style.backgroundColor = "rgb(161, 161, 161)";
            document.getElementsByTagName("button")[i].style.fontStyle = "normal";
        }

        function select(i, value) {
            document.getElementsByTagName("button")[i].setAttribute("disabled", "disabled")
            document.getElementsByTagName("button")[i].removeAttribute("onclick")
            document.getElementsByTagName("button")[i].style.backgroundColor = "rgb(220,180,50)";
            document.getElementsByTagName("button")[i].style.fontStyle = "italic";
        }

        function restoreCamera(i) {
            globalModel[i].on("loaded", () => {
                viewer.cameraFlight.flyTo({
                    projection: "perspective",
                    aabb: viewer.scene.getAABB({}),
                    duration: 0
                });
            });
        }

        //----------------------------------------------------------------------------------------------------------------------
        document.initAachenEarly = function () {

            select(0);
            enable(1, "document.initAachenMid()");
            enable(2, "document.initAachenEnd()");

            if (globalModel != undefined) { clearCanvas(); }

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/Aachen/buildings.xkt",
                metaModelSrc: "../app/data/projects/Aachen/buildings.json",
                edges: true
            }));

            globalModel[0].on("loaded", () => {
                globalModel.push(xktLoader.load({
                    src: "../app/data/projects/Aachen/streets.xkt",
                    metaModelSrc: "../app/data/projects/Aachen/streets.json",
                    edges: true,
                }));

                globalModel[1].on("loaded", () => {
                    globalModel.push(xktLoader.load({
                        src: "../app/data/projects/Aachen/pipes.xkt",
                        metaModelSrc: "../app/data/projects/Aachen/pipes.json",
                        edges: true,
                    }));

                    globalModel[2].on("loaded", () => {
                        viewer.cameraFlight.flyTo({
                            projection: "perspective",
                            eye: [25, 150, 75],
                            look: [0, 5, 0],
                            up: [-0.01, 0.99, 0.039],
                            duration: 0
                        });
                    });
                });
            });

            loadGeo("https://api.openweathermap.org/data/2.5/weather?id=3247449&appid=164d9c87e52c6093c36d1dc348e167d8");

        }

        //----------------------------------------------------------------------------------------------------------------------
        document.initAachenMid = function () {
            select(1);
            enable(0, "document.initAachenEarly()");
            enable(2, "document.initAachenEnd()");

            clearCanvas()



            globalModel.push(xktLoader.load({
                id: "buildings",
                src: "../app/data/projects/Aachen/buildings.xkt",
                metaModelSrc: "../app/data/projects/Aachen/buildings.json",
                edges: true
            }));

            globalModel[0].on("loaded", () => {
                globalModel.push(xktLoader.load({
                    id: "streets",
                    src: "../app/data/projects/Aachen/streets.xkt",
                    metaModelSrc: "../app/data/projects/Aachen/streets.json",
                    edges: true
                }));

                globalModel[1].on("loaded", () => {
                    globalModel.push(xktLoader.load({
                        id: "pipes",
                        src: "../app/data/projects/Aachen/pipes.xkt",
                        metaModelSrc: "../app/data/projects/Aachen/pipes.json",
                        edges: true
                    }));

                    globalModel[2].on("loaded", () => {
                        globalModel.push(xktLoader.load({
                            id: "sensor",
                            src: "../app/data/projects/Aachen/sensor.xkt",
                            metaModelSrc: "../app/data/projects/Aachen/sensor.json",
                            edges: true
                        }));

                        globalModel[3].on("loaded", () => {
                            globalModel.push(xktLoader.load({
                                id: "site",
                                src: "../app/data/projects/Aachen/site.xkt",
                                metaModelSrc: "../app/data/projects/Aachen/site.json",
                                edges: true
                            }));

                            globalModel[4].on("loaded", () => {
                                viewer.cameraFlight.flyTo({
                                    projection: "perspective",
                                    eye: [25, 150, 75],
                                    look: [0, 5, 0],
                                    up: [-0.01, 0.99, 0.039],
                                    duration: 0

                                });
                            });
                        });
                    });
                });
            });



            loadGeo("https://api.openweathermap.org/data/2.5/weather?id=3247449&appid=164d9c87e52c6093c36d1dc348e167d8");

        }

        //----------------------------------------------------------------------------------------------------------------------
        document.initAachenEnd = function () {
            select(2);
            enable(0, "document.initAachenEarly()");
            enable(1, "document.initAachenMid()");

            clearCanvas()

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/Aachen/built.xkt",
                metaModelSrc: "../app/data/projects/Aachen/built.json",
                edges: true
            }));

            globalModel[0].on("loaded", () => {
                globalModel.push(xktLoader.load({
                    src: "../app/data/projects/Aachen/buildings.xkt",
                    metaModelSrc: "../app/data/projects/Aachen/buildings.json",
                    edges: true,
                }));

                globalModel[0].on("loaded", () => {
                    globalModel.push(xktLoader.load({
                        src: "../app/data/projects/Aachen/streets.xkt",
                        metaModelSrc: "../app/data/projects/Aachen/streets.json",
                        edges: true,
                    }));

                    globalModel[1].on("loaded", () => {
                        globalModel.push(xktLoader.load({
                            src: "../app/data/projects/Aachen/pipes.xkt",
                            metaModelSrc: "../app/data/projects/Aachen/pipes.json",
                            edges: true,
                        }));

                        globalModel[2].on("loaded", () => {
                            viewer.cameraFlight.flyTo({
                                projection: "perspective",
                                eye: [25, 150, 75],
                                look: [0, 5, 0],
                                up: [-0.01, 0.99, 0.039],
                                duration: 0
                            });
                        });
                    });
                });
            });

            loadGeo("https://api.openweathermap.org/data/2.5/weather?id=3247449&appid=164d9c87e52c6093c36d1dc348e167d8");

        }

        //----------------------------------------------------------------------------------------------------------------------
        document.initWaterlock = function () {

            select(1);
            disable(0);
            disable(2);

            clearCanvas();

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WaterLock/models/design/geometry.xkt",
                metaModelSrc: "../app/data/projects/WaterLock/models/design/metadata.json",
                edges: true
            }));

            loadGeo("https://api.openweathermap.org/data/2.5/weather?id=2759661&appid=164d9c87e52c6093c36d1dc348e167d8");

            restoreCamera(0);

        }

        //----------------------------------------------------------------------------------------------------------------------
        document.initSchependomlaan = function () {

            select(2);
            disable(0);
            disable(1);

            clearCanvas();

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/Schependomlaan/models/design/geometry.xkt",
                metaModelSrc: "../app/data/projects/Schependomlaan/models/design/metadata.json",
                edges: true
            }));

            restoreCamera(0);

            loadGeo("https://api.openweathermap.org/data/2.5/weather?id=2750053&appid=164d9c87e52c6093c36d1dc348e167d8");

        }


        //----------------------------------------------------------------------------------------------------------------------
        document.initHospital = function () {

            select(2);
            disable(0);
            disable(1);

            clearCanvas();

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/architectural/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/architectural/metadata.json",
                edges: true
            }));

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/electrical/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/electrical/metadata.json",
                edges: true
            }));

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/fireAlarms/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/fireAlarms/metadata.json",
                edges: true
            }));

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/mechanical/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/mechanical/metadata.json",
                edges: true
            }));

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/plumbing/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/plumbing/metadata.json",
                edges: true
            }));

            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/sprinklers/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/sprinklers/metadata.json",
                edges: true
            }));


            globalModel.push(xktLoader.load({
                src: "../app/data/projects/WestRiversideHospital/models/structure/geometry.xkt",
                metaModelSrc: "../app/data/projects/WestRiversideHospital/models/structure/metadata.json",
                edges: true
            }));

            restoreCamera(6);

            loadGeo("https://api.openweathermap.org/data/2.5/weather?id=5368361&appid=164d9c87e52c6093c36d1dc348e167d8");

        }


        //----------------------------------------------------------------------------------------------------------------------
        // Create a tree view
        //----------------------------------------------------------------------------------------------------------------------


        const treeView = new TreeViewPlugin(viewer, {
            containerElement: document.getElementById("treeViewContainer"),
            autoExpandDepth: 0,
            hierarchy: "containment"
        });

        const treeViewContextMenu = new ContextMenu({

            items: [
                [
                    {
                        title: "View Fit",
                        doAction: function (context) {
                            const scene = context.viewer.scene;
                            const objectIds = [];
                            context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                                if (treeViewNode.objectId) {
                                    objectIds.push(treeViewNode.objectId);
                                }
                            });
                            scene.setObjectsVisible(objectIds, true);
                            scene.setObjectsHighlighted(objectIds, true);
                            context.viewer.cameraFlight.flyTo({
                                projection: "perspective",
                                aabb: scene.getAABB(objectIds),
                                duration: 0.5
                            }, () => {
                                setTimeout(function () {
                                    scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                                }, 500);
                            });
                        }
                    },
                    {
                        title: "View Fit All",
                        doAction: function (context) {
                            const scene = context.viewer.scene;
                            context.viewer.cameraFlight.flyTo({
                                projection: "perspective",
                                aabb: scene.getAABB({}),
                                duration: 0.5
                            });
                        }
                    }
                ],
                [
                    {
                        title: "X-Ray Others",
                        doAction: function (context) {
                            var entity = context.treeViewNode;
                            const viewer = context.viewer;
                            const scene = viewer.scene;
                            const metaObject = viewer.metaScene.metaObjects[entity.objectId];

                            //console.log(viewer.metaScene.metaObjects)
                            getInfo(metaObject);

                            if (lastEntity != null) {
                                lastEntity.colorize = lastColorize;
                                lastEntity = null;
                                lastColorize = null;
                                stopRefresh(globalRefresh);

                            }
                            if (context.entity != undefined) {
                                lastEntity = context.entity;
                                lastColorize = context.entity.colorize.slice();
                                context.entity.colorize = [1, 130 / 255, 0];
                            }
                            context.viewer.cameraFlight.flyTo({
                                projection: "perspective",
                                aabb: scene.getAABB(entity.objectId),
                                duration: 0.5
                            });

                            scene.setObjectsVisible(scene.objectIds, true);
                            scene.setObjectsXRayed(scene.objectIds, true);
                            scene.setObjectsSelected(scene.selectedObjectIds, false);
                            scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                            context.treeViewPlugin.withNodeTree(context.treeViewNode, (treeViewNode) => {
                                if (treeViewNode.objectId) {
                                    const entity = scene.objects[treeViewNode.objectId];
                                    if (entity) {
                                        entity.xrayed = false;
                                    }
                                }
                            });
                        }
                    },
                    {
                        title: "Reset X-Ray",
                        getEnabled: function (context) {
                            return (context.viewer.scene.numXRayedObjects > 0);
                        },
                        doAction: function (context) {
                            context.viewer.scene.setObjectsXRayed(context.viewer.scene.xrayedObjectIds, false);
                            clearProperty();
                            lastEntity.colorize = lastColorize;
                            lastEntity = null;
                            lastColorize = null;

                        }
                    }
                ]
            ]
        });

        // Right-clicking on a tree node shows the context menu for that node

        treeView.on("contextmenu", (e) => {

            treeViewContextMenu.context = { // Must set context before opening menu
                viewer: e.viewer,
                treeViewPlugin: e.treeViewPlugin,
                treeViewNode: e.treeViewNode,
                entity: e.viewer.scene.objects[e.treeViewNode.objectId] // Only defined if tree node is a leaf node
            };

            treeViewContextMenu.show(e.event.pageX, e.event.pageY);
        });

        // Left-clicking on a tree node isolates that object in the 3D view

        treeView.on("nodeTitleClicked", (e) => {
            const scene = viewer.scene;
            const entity = e.viewer.scene.objects[e.treeViewNode.objectId];
            const objectIds = [];

            e.treeViewPlugin.withNodeTree(e.treeViewNode, (treeViewNode) => {
                if (treeViewNode.objectId) {
                    objectIds.push(treeViewNode.objectId);
                }

            });
            e.treeViewPlugin.unShowNode();

            const metaObject = e.viewer.metaScene.metaObjects[objectIds[0]];

            scene.setObjectsXRayed(scene.objectIds, true);
            scene.setObjectsVisible(scene.objectIds, true);
            scene.setObjectsXRayed(objectIds, false);
            viewer.cameraFlight.flyTo({
                aabb: scene.getAABB(objectIds),
                duration: 0.5
            }, () => {
                setTimeout(function () {
                    scene.setObjectsVisible(scene.xrayedObjectIds, true);
                    scene.setObjectsXRayed(scene.xrayedObjectIds, true);
                }, 500);
            });


            if (lastEntity != null) {
                lastEntity.colorize = lastColorize;
                lastEntity = null;
                lastColorize = null;
                stopRefresh(globalRefresh);

            }
            if (entity != undefined) {
                lastEntity = entity;
                lastColorize = entity.colorize.slice();
                entity.colorize = [1, 130 / 255, 0];
            }

            getInfo(metaObject);

        });


        //------------------------------------------------------------------------------------------------------------------
        // Create two ContextMenus - one for right-click on empty space, the other for right-click on an Entity
        //------------------------------------------------------------------------------------------------------------------


        const canvasContextMenu = new ContextMenu({
            enabled: true,
            context: {
                viewer: viewer
            },
            items: [
                [
                    {
                        title: "Hide All",
                        getEnabled: function (context) {
                            return (context.viewer.scene.numVisibleObjects > 0);
                        },
                        doAction: function (context) {
                            context.viewer.scene.setObjectsVisible(context.viewer.scene.visibleObjectIds, false);
                        }
                    },
                    {
                        title: "Show All",
                        getEnabled: function (context) {
                            const scene = context.viewer.scene;
                            return (scene.numVisibleObjects < scene.numObjects);
                        },
                        doAction: function (context) {
                            const scene = context.viewer.scene;
                            scene.setObjectsVisible(scene.objectIds, true);
                            scene.setObjectsXRayed(scene.xrayedObjectIds, false);
                            scene.setObjectsSelected(scene.selectedObjectIds, false);
                        }
                    }
                ],
                [
                    {
                        title: "View Fit All",
                        doAction: function (context) {
                            context.viewer.cameraFlight.flyTo({
                                aabb: context.viewer.scene.getAABB()
                            });
                        }
                    }
                ]
            ]
        });

        const objectContextMenu = new ContextMenu({
            items: [
                [
                    {
                        title: "View Fit",
                        doAction: function (context) {
                            const viewer = context.viewer;
                            const scene = viewer.scene;
                            const entity = context.entity;
                            viewer.cameraFlight.flyTo({
                                aabb: entity.aabb,
                                duration: 0.5
                            }, () => {
                                setTimeout(function () {
                                    scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                                }, 500);
                            });
                        }
                    },
                    {
                        title: "View Fit All",
                        doAction: function (context) {
                            const scene = context.viewer.scene;
                            context.viewer.cameraFlight.flyTo({
                                projection: "perspective",
                                aabb: scene.getAABB(),
                                duration: 0.5
                            });
                        }
                    },
                    {
                        title: "Show in Tree",
                        doAction: function (context) {
                            const objectId = context.entity.id;
                            context.treeViewPlugin.showNode(objectId);
                        }
                    }
                ],
                [
                    {
                        title: "X-Ray Others",
                        doAction: function (context) {

                            const entity = context.entity;
                            const viewer = context.viewer;
                            const scene = viewer.scene;
                            const metaObject = viewer.metaScene.metaObjects[entity.id];

                            getInfo(metaObject);

                            if (!metaObject) {
                                return;
                            }

                            if (lastEntity != null) {
                                lastEntity.colorize = lastColorize;
                                lastEntity = null;
                                lastColorize = null;
                                stopRefresh(globalRefresh);

                            }
                            if (entity != undefined) {
                                lastEntity = entity;
                                lastColorize = entity.colorize.slice();
                                entity.colorize = [1, 130 / 255, 0];
                            }

                            viewer.cameraFlight.flyTo({
                                aabb: entity.aabb,
                                duration: 0.5
                            });

                            scene.setObjectsVisible(scene.objectIds, true);
                            scene.setObjectsXRayed(scene.objectIds, true);
                            scene.setObjectsSelected(scene.selectedObjectIds, false);
                            scene.setObjectsHighlighted(scene.highlightedObjectIds, false);
                            metaObject.withMetaObjectsInSubtree((metaObject) => {
                                const entity = scene.objects[metaObject.id];
                                if (entity) {
                                    entity.xrayed = false;
                                }
                            });
                        }
                    },
                    {
                        title: "Reset X-Ray",
                        getEnabled: function (context) {
                            return (context.viewer.scene.numXRayedObjects > 0);
                        },
                        doAction: function (context) {
                            context.viewer.scene.setObjectsXRayed(context.viewer.scene.xrayedObjectIds, false);
                            clearProperty();
                            lastEntity.colorize = lastColorize;
                            lastEntity = null;
                            lastColorize = null;

                        }
                    }
                ]
            ],
            enabled: true
        });

        viewer.cameraControl.on("rightClick", function (e) {

            var hit = viewer.scene.pick({
                canvasPos: e.canvasPos
            });

            if (hit && hit.entity.isObject) {

                objectContextMenu.context = { // Must set context before showing menu
                    viewer: viewer,
                    treeViewPlugin: treeView,
                    entity: hit.entity
                };

                objectContextMenu.show(e.event.pageX, e.event.pageY);

            } else {

                canvasContextMenu.context = { // Must set context before showing menu
                    viewer: viewer
                };

                canvasContextMenu.show(e.event.pageX, e.event.pageY);
            }

            e.event.preventDefault();
        });


        //------------------------------------------------------------------------------------------------------------------
        // Click entity to get info and highlight it
        //------------------------------------------------------------------------------------------------------------------


        var lastEntity = null;
        var lastColorize = null;

        viewer.cameraControl.on("picked", (pickResult) => {
            const entity = pickResult.entity;
            const metaObject = viewer.metaScene.metaObjects[entity.id];
            stopRefresh(globalRefresh);

            console.log(metaObject);
            getInfo(metaObject);

            if (!lastEntity || entity.id !== lastEntity.id) {
                if (lastEntity) {
                    lastEntity.colorize = lastColorize;
                    viewer.scene.setObjectsXRayed(viewer.scene.xrayedObjectIds, false);
                }
                lastEntity = pickResult.entity;
                lastColorize = pickResult.entity.colorize.slice();
                pickResult.entity.colorize = [1, 130 / 255, 0];
                viewer.scene.setObjectsXRayed(viewer.scene.xrayedObjectIds, false);
            } else if (entity.id == lastEntity.id || globalModel.length == 0) {
                stopRefresh(globalRefresh);

                lastEntity = null;
                pickResult.entity.colorize = lastColorize;
                clearProperty();
                viewer.scene.setObjectsXRayed(viewer.scene.xrayedObjectIds, false);
            }


        });


        //------------------------------------------------------------------------------------------------------------------
        // Create a mesh with grid
        //------------------------------------------------------------------------------------------------------------------


        new Mesh(viewer.scene, {
            geometry: new VBOGeometry(viewer.scene, buildGridGeometry({
                size: 1500,
                divisions: 150
            })),
            material: new PhongMaterial(viewer.scene, {
                color: [0.0, 0.0, 0.0],
                emissive: [0.4, 0.4, 0.4]
            }),
            position: [0, -5, 0],
            collidable: false
        });


        //------------------------------------------------------------------------------------------------------------------
        // Create a Navigation Cube
        //------------------------------------------------------------------------------------------------------------------


        new NavCubePlugin(viewer, {
            canvasId: "myNavCubeCanvas",
            visible: true,           // Initially visible (default)
            size: 200,               // NavCube size in pixels (default is 200)
            alignment: "topLeft",   // Align NavCube to top-left of Viewer canvas
            topMargin: 50,          // 170 pixels margin from top of Viewer canvas
            cameraFly: true,       // Fly camera to each selected axis/diagonal
            cameraFitFOV: 45,        // How much field-of-view the scene takes once camera has fitted it to view
            cameraFlyDuration: 0.5, // How long (in seconds) camera takes to fly to each new axis/diagonal
            color: "#FFFFFF",
            synchProjection: true
        });


    </script>



    <div class="container">
        <div class="headcontainer">

            <div class="header">

                <!-- Title -->
                <div class="header title">
                    <h1>Wingman - Construction Project Info Platform</h1>
                    <i>Beta Testing | v1.0.3</i>
                </div>

                <div class="nav">

                    <!-- Project selector/Drop down list -->
                    <div class="nav project">
                        <br />
                        <p>Project: <select>
                                <option value="Aachen" onclick="document.initAachenEarly()" selected>Aachen</option>
                                <option value="Waterlock" onclick="document.initWaterlock()">Waterlock</option>
                                <option value="Schependomlaan" onclick="document.initSchependomlaan()">
                                    Schependomlaan
                                </option>
                                <option value="West riverside hospital" onclick="document.initHospital()">
                                    West riverside hospital</option>
                            </select></p>
                    </div>

                    <!-- Phase selector -->
                    <div class="nav phase">

                        Phase: &nbsp;
                        <button onclick="">Early-term</button>
                        <button onclick="">Mid-term</button>
                        <button onclick="">End-term</button>

                    </div>

                </div>

            </div>

            <!-- Geo info -->
            <div class="geo">

                <p id="location">Loading geo data...</p>
                <p id="weather"></p>
                <p id="time"></p>

            </div>

            <div class="news">
                <marquee><i>Welcome to <b>Wingman</b></i></marquee>
            </div>

        </div>


        <!--middle-->
        <div class="midcontainer">

            <div class="layer">
                <h2>Info Layer</h2>

                <div id="treeViewContainer">


                </div>
            </div>

            <canvas id="myCanvas"></canvas>

            <canvas id="myNavCubeCanvas"></canvas>

            <div class="info">
                <h2>Information</h2>
                <p id="info"></p>
            </div>
        </div>


        <!--buttom-->
        <div class="buttomcontainer">


            <i>Copyright</i>
            <img src="../images/Lemonade_Logo_4_transparent_white.png" width="8%" alt="Team Lemonade">
            <img src="../images/dc_logo.svg" width="9%" alt="Lehrstuhl DC">
            <img src="../images/IP_logo_transparent.png" width="10%" alt="Lehrstuhl IP"
                style="padding-right: 1.5em; border-right: 1px white solid">
            <i>Supported by</i>
            <img src="../images/xeolabs_transparent.png" width="2%" alt="Xeolabs">
            <img src="../images/itnrw_logo.png" width="8%" alt="IT NRW">


        </div>
    </div>


</body>



</html>